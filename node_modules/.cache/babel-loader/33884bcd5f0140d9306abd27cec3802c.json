{"ast":null,"code":"import _defineProperty from\"/Users/hienle/Documents/GitHub/comfortNFT/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _objectSpread from\"/Users/hienle/Documents/GitHub/comfortNFT/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/Users/hienle/Documents/GitHub/comfortNFT/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/hienle/Documents/GitHub/comfortNFT/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import BigNumber from'bignumber.js';import{ethers}from'ethers';import Web3 from'web3';import ERC20ABI from'constants/abi/ERC20.json';import ERC1155 from'constants/abi/ERC1155.json';import{COOLING_OFF_IN_SECONDS}from'constants/poolValues';import StrainNFTLPTokenWrapper from'../yam-sdk/lib/clean_build/contracts/StrainNFTLPTokenWrapper.json';import StrainNft from'../yam-sdk/lib/clean_build/contracts/StrainNFT.json';import{Multicall}from'ethereum-multicall';import{Web3Provider}from'@ethersproject/providers';var sleep=function sleep(ms){return new Promise(function(resolve){return setTimeout(resolve,ms);});};export var waitTransaction=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(provider,txHash){var web3,txReceipt,r;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:web3=new Web3(provider);txReceipt=null;case 2:if(!(txReceipt===null)){_context.next=11;break;}_context.next=5;return web3.eth.getTransactionReceipt(txHash);case 5:r=_context.sent;txReceipt=r;_context.next=9;return sleep(2000);case 9:_context.next=2;break;case 11:return _context.abrupt(\"return\",txReceipt.status);case 12:case\"end\":return _context.stop();}}},_callee);}));return function waitTransaction(_x,_x2){return _ref.apply(this,arguments);};}();export var approve=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(userAddress,spenderAddress,tokenAddress,provider,onTxHash){var tokenContract;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;tokenContract=getERC20Contract(provider,tokenAddress);return _context3.abrupt(\"return\",tokenContract.methods.approve(spenderAddress,String(ethers.constants.MaxUint256)).send({from:userAddress,gas:80000},/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(error,txHash){var status;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!error){_context2.next=4;break;}console.log(\"ERC20 could not be approved\",error);onTxHash&&onTxHash('');return _context2.abrupt(\"return\",false);case 4:if(onTxHash){onTxHash(txHash);}_context2.next=7;return waitTransaction(provider,txHash);case 7:status=_context2.sent;if(status){_context2.next=11;break;}console.log(\"Approval transaction failed.\");return _context2.abrupt(\"return\",false);case 11:return _context2.abrupt(\"return\",true);case 12:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x8,_x9){return _ref3.apply(this,arguments);};}()));case 5:_context3.prev=5;_context3.t0=_context3[\"catch\"](0);console.error('approve',_context3.t0);return _context3.abrupt(\"return\",false);case 9:case\"end\":return _context3.stop();}}},_callee3,null,[[0,5]]);}));return function approve(_x3,_x4,_x5,_x6,_x7){return _ref2.apply(this,arguments);};}();export var setApprovalForAll=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(userAddress,spenderAddress,tokenAddress,provider,onTxHash){var tokenContract;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.prev=0;tokenContract=getERC1155Contract(provider,tokenAddress);return _context5.abrupt(\"return\",tokenContract.methods.setApprovalForAll(spenderAddress,true).send({from:userAddress,gas:80000},/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(error,txHash){var status;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(!error){_context4.next=4;break;}console.log(\"ERC1155 could not be approved\",error);onTxHash&&onTxHash('');return _context4.abrupt(\"return\",false);case 4:if(onTxHash){onTxHash(txHash);}_context4.next=7;return waitTransaction(provider,txHash);case 7:status=_context4.sent;if(status){_context4.next=11;break;}console.log(\"Approval for all transaction failed.\");return _context4.abrupt(\"return\",false);case 11:return _context4.abrupt(\"return\",true);case 12:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x15,_x16){return _ref5.apply(this,arguments);};}()));case 5:_context5.prev=5;_context5.t0=_context5[\"catch\"](0);console.log('set approval for all ',_context5.t0);return _context5.abrupt(\"return\",false);case 9:case\"end\":return _context5.stop();}}},_callee5,null,[[0,5]]);}));return function setApprovalForAll(_x10,_x11,_x12,_x13,_x14){return _ref4.apply(this,arguments);};}();export var isApprovalForAll=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(userAddress,spenderAddress,tokenAddress,provider){var tokenContract;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.prev=0;tokenContract=getERC1155Contract(provider,tokenAddress);return _context6.abrupt(\"return\",tokenContract.methods.isApprovedForAll(userAddress,spenderAddress));case 5:_context6.prev=5;_context6.t0=_context6[\"catch\"](0);console.log('set approval for all ',_context6.t0);return _context6.abrupt(\"return\",false);case 9:case\"end\":return _context6.stop();}}},_callee6,null,[[0,5]]);}));return function isApprovalForAll(_x17,_x18,_x19,_x20){return _ref6.apply(this,arguments);};}();export var getAllowance=/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(userAddress,spenderAddress,tokenAddress,provider){var tokenContract,allowance;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.prev=0;tokenContract=getERC20Contract(provider,tokenAddress);_context7.next=4;return tokenContract.methods.allowance(userAddress,spenderAddress).call();case 4:allowance=_context7.sent;return _context7.abrupt(\"return\",allowance);case 8:_context7.prev=8;_context7.t0=_context7[\"catch\"](0);return _context7.abrupt(\"return\",'0');case 11:case\"end\":return _context7.stop();}}},_callee7,null,[[0,8]]);}));return function getAllowance(_x21,_x22,_x23,_x24){return _ref7.apply(this,arguments);};}();export var getBalance=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(provider,tokenAddress,userAddress){var tokenContract,balance;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:tokenContract=getERC20Contract(provider,tokenAddress);_context8.prev=1;_context8.next=4;return tokenContract.methods.balanceOf(userAddress).call();case 4:balance=_context8.sent;return _context8.abrupt(\"return\",balance);case 8:_context8.prev=8;_context8.t0=_context8[\"catch\"](1);return _context8.abrupt(\"return\",'0');case 11:case\"end\":return _context8.stop();}}},_callee8,null,[[1,8]]);}));return function getBalance(_x25,_x26,_x27){return _ref8.apply(this,arguments);};}();var getUsersNftsMulticalResults=/*#__PURE__*/function(){var _ref9=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee9(provider,nftAddress,nftCount,userAddress){var multicall,items,i,contractGetNftIdsCall,nftIds,nftResults,contractGetNftOwnerCall,usersNfts,ownerResults;return _regeneratorRuntime.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0://let provider = new ethers.providers.StaticJsonRpcProvider(infura_key);\nmulticall=new Multicall({ethersProvider:provider});console.log('nft count:',nftCount);items=[];for(i=0;i<nftCount;i++){items.push(i);}contractGetNftIdsCall=items.map(function(i){return{reference:\"nftContract\".concat(i),contractAddress:nftAddress,abi:ERC1155.abi,calls:[{reference:\"nftContract\".concat(i),methodName:'itemIDs',methodParameters:[i]}]};});nftIds=[];_context9.next=8;return multicall.call(contractGetNftIdsCall);case 8:nftResults=_context9.sent;Object.keys(nftResults.results).map(function(key){// lame issue with typing and this array of calls\nvar nftId=String(new BigNumber(JSON.parse(JSON.stringify(nftResults.results[key].callsReturnContext[0].returnValues)).hex));nftIds.push(nftId);});contractGetNftOwnerCall=nftIds.map(function(i){return{reference:\"nftContract\".concat(i),contractAddress:nftAddress,abi:ERC1155.abi,calls:[{reference:\"nftContract\".concat(i),methodName:'nfOwners',methodParameters:[i]}]};});// ----- get NFT owner ----- //\nusersNfts=[];_context9.next=14;return multicall.call(contractGetNftOwnerCall);case 14:ownerResults=_context9.sent;Object.keys(ownerResults.results).map(function(key){// lame issue with typing and this array of calls\nvar owner=String(ownerResults.results[key].callsReturnContext[0].returnValues);if(owner.toLowerCase()===userAddress.toLowerCase()){var nftId=String(ownerResults.results[key].originalContractCallContext.calls[0].methodParameters[0]);usersNfts.push(nftId);}});return _context9.abrupt(\"return\",usersNfts);case 17:case\"end\":return _context9.stop();}}},_callee9);}));return function getUsersNftsMulticalResults(_x28,_x29,_x30,_x31){return _ref9.apply(this,arguments);};}();var getNftDetailsMulticalResults=/*#__PURE__*/function(){var _ref10=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee10(provider,nftAddress,nftIds){var multicall,nftDetails,contractGetNftDetailCalls,i,nftId,ownerResults;return _regeneratorRuntime.wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0://let provider = new ethers.providers.StaticJsonRpcProvider(infura_key);\nmulticall=new Multicall({ethersProvider:provider});nftDetails=nftIds.reduce(function(p,n){return _objectSpread(_objectSpread({},p),{},_defineProperty({},n,{nftId:n,dataUrl:'',nftName:''}));},{});contractGetNftDetailCalls=[];for(i=0;i<nftIds.length;i++){nftId=nftIds[i];contractGetNftDetailCalls.push({reference:\"nftContract\".concat(nftId,\"Uri\"),contractAddress:nftAddress,abi:ERC1155.abi,calls:[{reference:\"nftContract\".concat(nftId,\"Uri\"),methodName:'uri',methodParameters:[nftId]}]});contractGetNftDetailCalls.push({reference:\"nftContract\".concat(nftId,\"Name\"),contractAddress:nftAddress,abi:StrainNft.abi,calls:[{reference:\"nftContract\".concat(nftId,\"Name\"),methodName:'nftInfo',methodParameters:[nftId]}]});contractGetNftDetailCalls.push({reference:\"nftContract\".concat(nftId,\"Name\"),contractAddress:nftAddress,abi:StrainNft.abi,calls:[{reference:\"nftContract\".concat(nftId,\"Name\"),methodName:'getName',methodParameters:[nftId]}]});}// ----- get NFT details ----- //\n_context10.next=6;return multicall.call(contractGetNftDetailCalls);case 6:ownerResults=_context10.sent;Object.keys(ownerResults.results).map(function(key){var method=String(ownerResults.results[key].originalContractCallContext.calls[0].methodName);var nftId=String(ownerResults.results[key].originalContractCallContext.calls[0].methodParameters[0]);var value=ownerResults.results[key].callsReturnContext[0].returnValues;if(method==='uri'){nftDetails[nftId].dataUrl=String(value);}else if(method==='nftInfo'){nftDetails[nftId].nftInfo=value;}else if(method==='getName'){nftDetails[nftId].nftName=String(value);}});return _context10.abrupt(\"return\",Object.values(nftDetails));case 9:case\"end\":return _context10.stop();}}},_callee10);}));return function getNftDetailsMulticalResults(_x32,_x33,_x34){return _ref10.apply(this,arguments);};}();export var getUserNfts=/*#__PURE__*/function(){var _ref11=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee11(provider,nftAddress,userAddress,crafterContract,geneticsContract){var nftContract,_window,length,p,usersNfts,nfts,userItems,i,nft,_yield$getNftPoolIdBa,poolId,lpBalance,now,timePassed;return _regeneratorRuntime.wrap(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:nftContract=getERC1155Contract(provider,nftAddress);_context11.prev=1;_context11.next=4;return nftContract.methods.getItemIDsLength().call();case 4:length=_context11.sent;// @ts-ignore\np=new Web3Provider((_window=window)===null||_window===void 0?void 0:_window.ethereum);_context11.next=8;return getUsersNftsMulticalResults(p,nftAddress,length,userAddress);case 8:usersNfts=_context11.sent;_context11.next=11;return getNftDetailsMulticalResults(p,nftAddress,usersNfts);case 11:nfts=_context11.sent;userItems=[];i=0;case 14:if(!(i<nfts.length)){_context11.next=31;break;}nft=nfts[i];_context11.next=18;return getNftPoolIdBalance(provider,crafterContract,nft.nftId,userAddress);case 18:_yield$getNftPoolIdBa=_context11.sent;poolId=_yield$getNftPoolIdBa.poolId;lpBalance=_yield$getNftPoolIdBa.lpBalance;nft.lpBalance=lpBalance;nft.poolId=poolId;// add convenience property\nnow=new Date().getTime()/1000;timePassed=now-Number(nft.nftInfo?nft.nftInfo.lastBreedTime:0);nft.canBreed=timePassed>COOLING_OFF_IN_SECONDS;// TODO: verify genetics contract address then turn this on\n//nft.breedFee = await getNftBreedingBurnFee(provider, geneticsContract, nft, userAddress);\nnft.breedFee=\"10000000000000000000\";userItems.push(nft);case 28:i++;_context11.next=14;break;case 31:// for debugging\nconsole.log('users NFTs',userItems);return _context11.abrupt(\"return\",userItems);case 35:_context11.prev=35;_context11.t0=_context11[\"catch\"](1);return _context11.abrupt(\"return\",[]);case 38:case\"end\":return _context11.stop();}}},_callee11,null,[[1,35]]);}));return function getUserNfts(_x35,_x36,_x37,_x38,_x39){return _ref11.apply(this,arguments);};}();export var getNftBreedingBurnFee=/*#__PURE__*/function(){var _ref12=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee12(provider,contract,nft,userAddress){var _nft$nftInfo,_nft$nftInfo2,_nft$nftInfo3;var fee;return _regeneratorRuntime.wrap(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:fee=\"0\";// set default\n_context12.next=3;return contract.methods.getBurnerFee((_nft$nftInfo=nft.nftInfo)===null||_nft$nftInfo===void 0?void 0:_nft$nftInfo.gnome,(_nft$nftInfo2=nft.nftInfo)===null||_nft$nftInfo2===void 0?void 0:_nft$nftInfo2.breedCount,(_nft$nftInfo3=nft.nftInfo)===null||_nft$nftInfo3===void 0?void 0:_nft$nftInfo3.lastBreedTime).call().catch(function(e){console.error(\"Could not get NFT's pool Id, defaulting to `0`\",e);});case 3:fee=_context12.sent;return _context12.abrupt(\"return\",fee);case 5:case\"end\":return _context12.stop();}}},_callee12);}));return function getNftBreedingBurnFee(_x40,_x41,_x42,_x43){return _ref12.apply(this,arguments);};}();export var getNftPoolIdBalance=/*#__PURE__*/function(){var _ref13=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee13(provider,contract,nftId,userAddress){var poolId,poolContactAddress,lpWrapperContract,lpBalance;return _regeneratorRuntime.wrap(function _callee13$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:poolId=\"0\";// set default\n_context13.next=3;return contract.methods.nftPool(nftId).call().catch(function(e){console.error(\"Could not get NFT's pool Id, defaulting to `0`\",e);});case 3:poolId=_context13.sent;_context13.next=6;return contract.methods.pools(poolId).call().catch(function(e){console.error(\"Could not get NFT's balance\",e);});case 6:poolContactAddress=_context13.sent;lpWrapperContract=getLPTokenWrapperContract(provider,poolContactAddress);_context13.next=10;return lpWrapperContract.methods.originalBalanceOf(nftId).call().catch(function(e){console.error(\"Could not get NFT's balance\",e);});case 10:lpBalance=_context13.sent;return _context13.abrupt(\"return\",{poolId:poolId,lpBalance:new BigNumber(lpBalance).dividedBy(new BigNumber(10).pow(18))});case 12:case\"end\":return _context13.stop();}}},_callee13);}));return function getNftPoolIdBalance(_x44,_x45,_x46,_x47){return _ref13.apply(this,arguments);};}();export var getERC20Contract=function getERC20Contract(provider,address){var web3=new Web3(provider);var contract=new web3.eth.Contract(ERC20ABI.abi,address);return contract;};export var getERC1155Contract=function getERC1155Contract(provider,address){var web3=new Web3(provider);var contract=new web3.eth.Contract(ERC1155.abi,address);return contract;};export var getLPTokenWrapperContract=function getLPTokenWrapperContract(provider,address){var web3=new Web3(provider);var contract=new web3.eth.Contract(StrainNFTLPTokenWrapper.abi,address);return contract;};export var bnToDec=function bnToDec(bn){var decimals=arguments.length>1&&arguments[1]!==undefined?arguments[1]:18;return bn.dividedBy(new BigNumber(10).pow(decimals)).toNumber();};export var decToBn=function decToBn(dec){var decimals=arguments.length>1&&arguments[1]!==undefined?arguments[1]:18;return new BigNumber(dec).multipliedBy(new BigNumber(10).pow(decimals));};export var getFullDisplayBalance=function getFullDisplayBalance(balance){var decimals=arguments.length>1&&arguments[1]!==undefined?arguments[1]:18;return balance.dividedBy(new BigNumber(10).pow(decimals)).toFixed();};export var setItemValue=function setItemValue(items,index,value){items[Number(index)]=value;return items;};export var getItemValue=function getItemValue(){var items=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var index=arguments.length>1&&arguments[1]!==undefined?arguments[1]:\"0\";return items[Number(index)];};","map":null,"metadata":{},"sourceType":"module"}